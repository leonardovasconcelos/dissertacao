\section{Sincronização Multi-saltos}

\outline{
\begin{itemize}
 \item Formato da mensagem de sincronização.
 \item Gerenciamento de informação redundante.
 \item Eleição do nó raiz.
 \item Evento: enviar/receber mensagem de sincronia. 
\end{itemize}

}



A sincronização multi-saltos do FTSP usa pontos de referência. Esses pontos são pares de \textit{timestamps}, um com o tempo global e outro local, ambos referem-se ao mesmo instante de tempo. Eles são capturados no envio e recebimento de mensagens, como descrito na Seção \ref{sec:ftsp_timestamp}, são transmitidos pelo nó \textit{root} ou qualquer nó que esteja sincronizado. O nó \textit{root} é eleito e reeleito dinamicamente, ele é o responsável por difundir periodicamente mensagens de sincronização, os nós ao seu alcance armazenam os pontos de referência. Nós que não estão ao alcance de transmissão do \textit{root}, recebem através dos nós intermediários que já estejam sincronizados. Quando os nós têm pontos suficientes, eles são capazes de calcular seu respectivo \textit{offset} e taxa de escorregamento do relógio. As principais questões sobre esse procedimento são: a mensagem de sincronização, tratamento da redundância de informação, eleição do \textit{root}.

\textbf{Mensagem de sincronização:} A primeira questão do processo de sincronização é o conteúdo e o formato da mensagem de sincronização do FTSP, a seguir os campos.
\begin{itemize}
 \item \texttt{rootID}: Este campo tem a informação do ID do \textit{root}, referente ao nó que enviou a mensagem.
 \item \texttt{globalTime}: É a estimativa do tempo global do nó emissor no momento do envio da mensagem.
 \item \texttt{seqNum}: É um número que é incrementado toda vez que o \textit{root} inicia uma nova rodada de sincronização. O \texttt{seqNum} é utilizado para que os nós sincronizados possam sabem quando uma mensagem é nova, assim conseguem diminuir a redundância de informação.
\end{itemize}

\textbf{Informação redundante:} Em uma rede com alta densidade de dispositivos, os nós recebem várias mensagens de outros nós ao seu alcance. Algumas delas com uma referência já lida, recebida de outro nó. Com o intuito de filtrar mensagens desnecessárias os nós mantém o valor do \texttt{highestSeqNum}, só utilizando mensagens com número de sequência (\texttt{seqNum}) maior do que o valor armazenado em \texttt{highestSeqNum}.

\textbf{Problema da eleição do nó \textit{root}}: Durante o funcionamento de uma redes de sensores, alguns nós podem falhar, novos nós podem ser inseridos ou saírem do alcance da rede. Como é necessário apenas um \textit{root} para o funcionamento da rede, um processo de eleição deve ser realizado sempre houver uma mudança que venha a afetar o nó raiz. O processo de eleição do FTSP é baseado no menor ID, quando o nó tem o menor ID ele se auto declara \textit{root} e passa a sincronizar os outros nós, mas não antes de sincronizar-se com o tempo global da rede primeiro.






%%A mensagem de sincronização compreende um \textit{timestamp} do emissor, que é estimativa de tempo global e \texttt{rootID} que é 




\begin{figure}[h]
\begin{Verbatim}[numbers=left,numbersep=1pt,frame=single]
event Radio.receive(TimeSyncMsg *msg){
  if( msg->rootID < myRootID )
      myRootID = msg->rootID;
  else if( msg->rootID > myRootID
    || msg->seqNum <= highestSeqNum )
      return;
  highestSeqNum = msg->seqNum;
  if( myRootID < myID )
      heartBeats = 0;
  if( numEntries >= NUMENTRIES_LIMIT
    && getError(msg) > TIME_ERROR_LIMIT )
      clearRegressionTable();
  else
      addEntryAndEstimateDrift(msg);
}
\end{Verbatim} 
 \caption{FTSP: Rotina do receptor \cite{maroti2004} }%\vspace{0em}
 \label{figure1}
\end{figure}


A Figura \ref{figure1} mostra a rotina de recebimento de mensagens de sincronização. 
As linhas 2 e 3 comparam o \texttt{rootID} da mensagem de sincronização recebida com a informação local que o nó tem sobre que é o \textit{root} \texttt{myRootID}.
Se a mensagem recebida tem o \texttt{rootID} menor, o nó assume \texttt{rootID} como seu root.
As linhas de 4 a 7 ignoram as mensagens que tenham um \texttt{rootID} e \texttt{seqNum} menores, pois possuem informação irrelevante.
Se \texttt{seqNum} é maior, o valor de \texttt{highestSeqNum} é atualizado.
Linhas 8 e 9 fazem o nó \textit{root} desistir de ser a \textit{root} da rede quando existe um \texttt{rootID} menor que seu próprio ID.
No caso de \texttt{rootID} ser maior que o verificado se o \texttt{seqNum} é maior ou igual ao valor do \texttt{highestSeqNum}, esta checagem previne informações redundantes por que a mensagem será apenas usada quando o \texttt{rootID} for menor ou igual a \texttt{myRootID} e o numero maior que o valor de \texttt{highestSeqNum}.
Linhas 10 e 15 verificam se o tempo da mensagem está em discordância com a estimativa de tempo global mais recente, se é aplicável limpa a tabela de regressão, se não, acumula a mensagem para calcular a regressão linear e sincronizar.
As linhas 10 a 15 armazenam mensagens de sincronização para calcular a regressão linear e realizar a sincronização.





\begin{figure}[h]
   \begin{Verbatim}[numbers=left,numbersep=1pt,frame=single]
event Timer.fired() {
  ++heartBeats;
  if( myRootID != myID
    && heartBeats >= ROOT_TIMEOUT )
      myRootID = myID;
  if( numEntries >= NUMENTRIES_LIMIT
    || myRootID == myID ){
      msg.rootID = myRootID;
      msg.seqNum = highestSeqNum;
      Radio.send(msg);
  if( myRootID == myID )
      ++highestSeqNum;
  }
}
  \end{Verbatim}
  \caption{FTSP: Rotina do emissor \cite{maroti2004}}
  \label{figure2}
\end{figure}


A Figura \ref{figure2} mostra a rotina de envio de mensagem. 
Um nó decide tornar-se \textit{root} por que está sem receber mensagens de sincronização por \texttt{ROOT\_TIMEOUT} (linhas 3 a 5).
Um nó envia mensagens de sincronização se ele é o \textit{root} ou se está sincronizado (linhas 6 a 10).
Se um nó é o \textit{root}, ele também tem que incrementar seu \textit{highestSeqNum}.





% \begin{figure}[H]
% \center
% 
% \subfigure[fig:grafo1][Em um primeiro momento, todos os nós iniciam. As linhas pontilhadas denotam o alcance de transmissão do nó. O
% nó 1 encontra-se desligado.]
%         {\includegraphics[width=6cm]{./figuras/ftsp_grafo1.eps}}
% ~
% \subfigure[fig:grafo2][Como não receberam mensagens suficientes, múltiplos nós se declaram \textit{roots} na rede. Eles começam a enviar e receber mensagens de sincronização.]
%         {\includegraphics[width=6cm]{./figuras/ftsp_grafo2.eps}}
% ~
% \subfigure[fig:grafo3][Nós começam a receber mensagens com \texttt{rootID} menor, logo atualizam sua referência. Dependendo de sua distância alguns nós ainda não tem a referencia atualizada, exemplo nó 4.]
%         {\includegraphics[width=6cm]{./figuras/ftsp_grafo3.eps}}
% \quad
% \subfigure[fig:grafo4][A rede convergiu, e todos os nós ativos da rede estão sincronizados com o nó 2. Mensagens entre os nós 5-6 tem \texttt{seqNum} menor que \texttt{highestSeqNum} então são descartadas por redundância.]
%         {\includegraphics[width=6cm]{./figuras/ftsp_grafo4.eps}}
% \quad
% \subfigure[fig:grafo5][Nó 1 é ativado, sendo o menor ID da rede vai tornar-se o \textit{root}, porém precisa primeiro preencher sua tabela de regressão e sincronizar com o tempo global, após estar sincronizado passa a enviar de mensagens de sincronização.]
%         {\includegraphics[width=6cm]{./figuras/ftsp_grafo5.eps}}
% \quad
% \subfigure[fig:grafo6][Nó 1 declara-se \textit{root}, passa a enviar suas mensagens de sincronização, após algumas rodadas a rede converge e todos os nós estão com \texttt{myRootID} = 1.]
%         {\includegraphics[width=6cm]{./figuras/ftsp_grafo6.eps}}
% % \qquad
% % \subfigure[fig:grafo_leg][Legenda]{\includegraphics[width=2cm]{./figuras/ftsp_grafo_legenda.eps}}
% \caption{Eleição de lider}\label{fig:lider}
% 
% \end{figure}




