\section{TPSN}
\outline{
    TPSN não elimina incerteza no sender, apenas minimiza o erro.
    Ele tenta reduzir este não determinismo utilizando timestamping da mensagem na camada MAC.
}

O TPSN (\textit{Timing-sync Protocol for Sensor Networks}) introduzido por Ganeriwal et. al. em 2003 \cite{ganeriwal2003}, usa o modelo \textit{sender-receiver} e organiza a rede na estrutura de uma árvore. Um único nó sincroniza toda a rede, para reduzir incertezas relativas a acesso ao meio o TPSN utiliza \textit{timestamp} na camada MAC. É dividido em duas fases descritas a seguir:

\textbf{Fase de Descoberta de Nível:} Esta fase é responsável por criar uma topologia hierárquica da rede, inicia no momento que a rede é ligada definindo um nó como $root$ e atribuindo seu nível como 0. O nó $root$ envia uma mensagem de descoberta chamada \texttt{level\_discovery}, que contém seu nível e identificador, todos os nós vizinhos que recebem este pacote usam ele para identificar seu próprio nível, somando 1 ao nível do pacote recebido. Então, estes vizinhos imediatos ao $root$ reenviam a mensagem de descoberta com seu próprio identificador e nível adiante. Este processo repete-se até que eventualmente todos os nós tenham identificado seu próprio nível. Caso um nó não tenha identificado seu nível, seja por erro na troca de mensagem ou por ter ingressado na rede após a fase de descoberta ter sido concluída. Este nó pode enviar uma mensagem de \texttt{level\_request} e seus vizinhos irão responder com seus respectivos níveis. Assim, ele atribui seu nível como sendo 1 a mais do que o menor nível dentre os recebidos. Uma falha importante que dever ser mencionada é o caso da reeleição do nó $root$, caso este venha a cair, nesta hipótese um dos nós do nível 1 é eleito e dá início a uma nova fase de descoberta.



\textbf{Fase de Sincronização:} Com a estrutura hierárquica da rede criada na fase anterior, temos o início da sincronização propriamente dita. O TPSN usa sincronização \textit{pairwise} entre as arestas e funciona de forma similar ao LTS, iniciando a partir do $root$ e avançando até os níveis mais externos da rede. Primeiramente o nó $root$ envia uma mensagem \texttt{time\_sync}, quando o nó no nível 1 recebe a mensagem eles iniciam uma sincronização bidirecional, ao final ele será capaz de calcular seu escorregamento, \textit{offset} e o tempo de propagação e assim ajustar o seu relógio. Os nós no nível 2 são capazes de escutar a comunicação realizada pelo nível 1, assim aguardam um tempo de \textit{backoff} para iniciar o mesmo processo de sincronização. Esse tempo de espera é necessário para que os nós terminem de ajustar seus relógios. O processo continua nos níveis subsequentes até que toda estrutura esteja sincronizada.



O TPSN trouxe importantes contribuições para os protocolos de sincronização de RSSF, algumas de suas principais vantagens são listadas a seguir:
%Vantagens do TPSN:

\begin{itemize}
 \item O protocolo suporta sincronização \textit{post-facto}, como forma de economia de energia.
 \item O TPSN foi desenvolvido para ser um protocolo multi-salto, assim teoricamente o tamanho da faixa de transmissão não causa problema.
 \item Tem incerteza no tempo de envio, ele tenta reduzir este indeterminismo usando \textit{timestamp} na camada mac
\end{itemize}

A seguir alguns dos pontos fracos do protocolo:
\begin{itemize}
 \item Autores não explicaram como o protocolo poderia suportar \textit{sleep mode} sem quebrar a estrutura da árvore.
 \item Autores concluem que TPSN tem performance 2 vezes superior ao RBS, porém nos testes é apresentado o \textit{offset} máximo do TPSN foi de 17 $\mu s$, maior que os 3 $\mu s$ do RBS.
 \item Mobilidade pode causar a necessidade de reconstrução da árvore.
 \item Depende de \textit{hardware} específico para o funcionamento do \textit{timestamp} na camada MAC.
 \item O Tempo de sincronização aumenta com o com o crescimento do número de níveis. 
\end{itemize}



