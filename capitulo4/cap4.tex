\chapter{FTSP+} \label{cap:cap4}
\outlineon=1

\outline{
  \begin{itemize}
    \item Explicar a técnica.
    \item Inserir ilustração do processo de sincronização com o relógio externo. 
    \item Pseudo código
    \item FTSP+ e subsection
  \end{itemize}
}

As principais técnicas para o cálculo e estimativa do atraso trabalham com \textit{timestamp} no nível de acesso ao meio ou com a troca de mensagens, ambas são custosas, visto que mecanismos de marcação de tempo na camada MAC são dependentes de \textit{hardware} específico e a troca de mensagens quebra com a premissa unidirecional do FTSP. Nós propusemos então o FTSP+ que substitui o recurso de MAC \textit{timestamp} por um \textit{timestamp} a nível de aplicação, baseado na ideia de que um nó é capaz de determinar no envio de uma mensagem quando ela termina de ser enviada, então é possível calcular os atrasos no processo de envio e com uma mensagem posterior efetuar a correção do \textit{timestamp}. Esta método já foi previamente discutido por \cite{sousa2014stele} que é uma técnica simples de estimativa de atraso local para RSSF.

\section{Técnica}

\outline{Descrever o processo de cálculo do tempo de acesso ao meio, e onde foi baseado.}


Em qualquer técnica de sincronização de relógios em sistemas distribuídos, os nós tem que dizer um ao outro o seu tempo local. A Figura \ref{fig:diagrama} ilustra esse cenário. O nó emissor armazena o seu tempo local ${t_1}'$ na mensagem de sincronização no tempo $t_1$ e ordena o envio da mensagem. Devido as incertezas aleatórias do acesso ao meio, o emissor só recebe o acesso ao meio no tempo $t_2$ e começa a enviar a mensagem. O \textit{tempo de acesso ao meio} é definido por $t_2 - t_1$. A mensagem propaga-se sobre o meio por um intervalo de tempo $tp$ até que atinge o rádio do receptor no tempo $t_3$. O \textit{tempo de propagação} é definido por $tp$. Devido as políticas de manipulação de interrupção e processamento do cabeçalho do pacote, o nó receptor marca o \textit{timestamp} do recebimento no tempo $t_4$ com o seu tempo local ${t_4}''$. O \textit{tempo de processamento} é dado por $t_4 - t_3$.

% In any distributed time synchronization technique, nodes have to tell each other their local time.
% Figure \ref{fig:diagrama} depicts this scenario.
% The sending node stores its local time $t1'$ in the synchronization message at time $t1$ and orders the message to be sent.
% Due to medium random access uncertainties, the sending node only gets access to the medium at time $t2$ and starts sending me message.
% $t2-t1$ is called \textit{medium access time}.
% The message propagates over the medium for an interval of time $tp$ until it reaches the receiver radio at time $t3$.
% $tp$ is the \textit{propagation time}.
% Due to interrupt handling policies and packet header processing, the receiver node timestamps the message receipt at time $t4$ with its local time $t4''$.
% $t4-t3$ is the \textit{processing time}.

\begin{figure}[htbp]
	\centering
		\includegraphics[width=\linewidth]{figuras/diagrama.eps}
	\caption{Syncronization steps.}
	\label{fig:diagrama}
\end{figure}


A imprecisão de sincronização acontece porque o nó de receptor pensa que no tempo $t_4$ o emissor tem o tempo ${t_1}'$ e o receptor tem o tempo ${t_4}''$. Como podemos ver na Figura \ref{fig:diagrama}, isso não é verdade. No tempo $t_4$, o nó emissor tem o tempo ${t_4}' = {t_1}' + \mbox{\textit{tempo de acesso ao meio}} + \mbox{\textit{tempo de propagação}} + \mbox{\textit{tempo processamento}}$. O \textit{timestamp} na camada MAC faz \textit{tempo de acesso ao meio} e \textit{tempo de processamento} igual a zero. Desde que o \textit{tempo de propagação} é desprezível ($\sim 1\mu{s}$) \cite{maroti2004}, algumas políticas de sincronização -- incluindo o FTSP -- podem atingir uma precisão muito boa. Contudo, sem o \textit{timestamp} na camada MAC, esses tempo não são negligenciáveis e tem que ser calculados.



\section{Modificação}\label{sec:mod}

\outline{
   Pseudo código com explicação do passo-a-passo do algoritmo (no sender e no receiver).
}


O FTSP+ calcula o \textit{tempo de acesso ao meio} usando uma manipulação de interrupção para marcar o tempo do momento que o nó obtém o acesso ao meio para enviar a mensagem de sincronização. Embora o acesso ao meio é concedido no tempo ${t_2}'$, \textit{timestamp de acesso ao meio} é igual a ${t_2}'+\delta$, onde $\delta$ é o \textit{overhead} para processar a manipulação da interrupção.

% FTSP+ calculates \textit{medium access time} using an interrupt handler to time stamp the moment that the node gets medium access to send the synchronization message.
% Although medium access is granted at time $t2'$, \textit{medium access timestamp} equals $t2'+\delta$, where $\delta$ is the overhead to process the interrupt handler.

O emissor envia uma mensagem com o conteúdo ${t_2}'+\delta-{t_1}'$ então o receptor pode estimar ${t_4}'$. Vamos chamar esta estimativa de $\bar{{t_4}'}$. O receptor calcula $\bar{{t_4}'}$ as in Equação \eqref{eq:estimated_t4}.

% The sender sends a correction message with content $t2'+\delta-t1'$ so the receiver can estimate $t4'$.
% Let us call this estimation $\bar{t4'}$.
% The receiver calculates $\bar{t4'}$ as in Equation \eqref{eq:estimated_t4}.

\begin{eqnarray}
\bar{t4'} & = & t1' - (t2' + \delta - t1') \nonumber\\
\label{eq:estimated_t4}
\bar{t4'} & = & t1' + \mbox{\textit{medium access time}} + \delta
\end{eqnarray}

%The difference between $t4'$ and $\bar{t4'}$, which is the estimation error, is:

A estimativa de erro é a diferença entre ${t_4}'$ e $\bar{t_4}'$, que é:
\begin{equation}
\label{eq:estimation_error}
t4' - \bar{t4'} = \mbox{\textit{propagation time}} + \mbox{\textit{processing time}} - \delta
\end{equation}

Desde de que o \textit{tempo de processamento} e o $\delta$ são latências do processamento da manipulação de interrupção. 
Nós investigamos seus valores em nosso experimento na Seção \ref{exp:1}, eles tendem a anular-se mutuamente. Relembrando que o \textit{tempo de propagação} é negligenciável.


% Since \textit{processing time} and $\delta$ are interrupt handler processing latencies, they tend to cancel out each other.
% We investigate their values in our experiments in Section \ref{sec:evaluation}.
% Remember that \textit{propagation time} is negligible.


\begin{figure}
\begin{Verbatim}[numbers=left,numbersep=1pt,frame=single]
event Radio.receiveSyncMsg(SyncMsg *msg){
  if( msg->rootID < myRootID )
      myRootID = msg->rootID;
  else if( msg->rootID > myRootID
    || msg->seqNum <= highestSeqNum )
      return;
  highestSeqNum = msg->seqNum;
  if( myRootID < myID )
      heartBeats = 0;
  if( numEntries >= NUMENTRIES_LIMIT
    && getError(msg) > TIME_ERROR_LIMIT )
      clearRegressionTable();
  else if (MAC_Time==false){
      addToWaitCorrectionMsgList(msg);
  }else{
      addEntryAndEstimateDrift(msg); 
  }  
}

event Radio.receiveCorrectionMsg(
                            CorrectionMsg *msg){
  applyCorrection(msg);
  addEntryAndEstimateDrift(msg);
}
\end{Verbatim}
 \caption{Receiver algorithm}\vspace{1em}
 \label{fig:receiver_ftspplus}
\end{figure}

Como podemos ver na Figura \ref{fig:receiver_ftspplus}, o receptor FTSP+ tem rotinas para manipular dois tipos diferentes de mensagens de recebimento: \texttt{Radio.receiveSyncMsg(SyncMsg *msg)} serve para as mensagens de sincronização e o \texttt{Radio.receiveCorrectionMsg(CorrectionMsg *msg)} é utilizado nas mensagens de correção. O \textit{tempo de correção}, expressado na Equação (\ref{eq:correction_time}), é a informação que é transmitida para o receptor aplicar como correção da mensagem anterior.

% As can be seen in Figure \ref{fig:receiver_ftspplus}, an FTSP+ receiver has routines to handle two different types of income messages: \texttt{Radio.receiveSyncMsg(SyncMsg *msg)} handles synchronization messages and \texttt{Radio.receiveCorrectionMsg(CorrectionMsg *msg)} handles correction messages.
% The \textit{correction time}, expressed in Equation (\ref{eq:correction_time}), is the information that is transmitted to the receiver to apply the correction to previous messages.

\begin{equation}
 \label{eq:correction_time}
 \mbox{\textit{correction time}} = t2' - t1' + \delta
\end{equation}


A rotina \texttt{Radio.receiveSyncMsg(SyncMsg *msg)} é diferente do receptor do FTSP somente nas linhas 13 e 14. Estas linha armazenam mensagens de sincronização em uma lista para aguardarem por suas respectivas mensagens de correção, caso MAC \textit{timestamp}  não esteja disponível.

% \texttt{Radio.receiveSyncMsg(SyncMsg *msg)} differs from FTSP receive only for lines 13 and 14.
% These lines store synchronization messages in a list to wait for the correction messages if MAC layer time-stamping is not available.

Já a rotina \texttt{Radio.receiveCorrectionMsg(CorrectionMsg *msg)} recebe a mensagem com o valor da correção, e usa a função \texttt{applyCorrection(msg)} para aplicar a correção e remover da lista de espera as mensagens de sincronização que correspondem com a mensagem de correção recebida, corrige o \textit{timestamp} e chama a função \texttt{addEntryAndEstimateDrift(msg)} que adiciona o valor já corrigido na tabela de regressão.


% \texttt{Radio.receiveCorrectionMsg(CorrectionMsg *msg)} receives the message with the correction value, use the function \texttt{applyCorrection(msg)} that applies the correction and removes from the wait list the synchronization message that matches the incoming correction message, corrects the timestamp and calls function \texttt{addEntryAndEstimateDrift(msg)}.



\begin{figure}[h]
\begin{Verbatim}[numbers=left,numbersep=1pt,frame=single]
event Timer.fired() {
  ++heartBeats;
  if( myRootID != myID
    && heartBeats >= ROOT_TIMEOUT )
      myRootID = myID;
  if( numEntries >= NUMENTRIES_LIMIT
    || myRootID == myID ){
      msg.rootID = myRootID;
      msg.seqNum = highestSeqNum;
      initialTime = call getLocalTime();
      msg.timestamp = initialTime;
      Radio.send(msg);
  if( myRootID == myID )
      ++highestSeqNum;
  }
}


event sendDone(SyncMsg *msg, error_t error){
 finalTime = call getLocalTime();
 correctionMsg.correction = finalTime-initialTime;
 correctionMsg.seqNum = msg.seqNum;
 Radio.send(correctionMsg);
}
\end{Verbatim}
 \caption{Sender algorithm}\vspace{1em}
 \label{fig:sender_ftspplus}
\end{figure}

A Figura \ref{fig:sender_ftspplus} apresenta a listagem do código da rotina do emissor do FTSP+, são duas funções \texttt{Timer.fired()} que periodicamente envia mensagens de sincronização (igual ao FTSP) e \texttt{sendDone(message\_t *msg, error\_t error)} que envia a mensagem de correção.


% As can be seen in Figure \ref{fig:sender_ftspplus}, an FTSP+ sender has two routines: \texttt{Timer.fired()} periodically sends synchronization messages (like in FTSP) and \texttt{sendDone(message\_t *msg, error\_t error)} sends the correction message.

O \texttt{Timer.fired()} difere do FTSP somente pelas linhas 10 e 11, que coleta o \textit{timestamp} no nível de aplicação. 
% \texttt{Timer.fired()} differs from FTSP only for lines 10 and 11, which collects the timestamp at application level.
A rotina \texttt{sendDone(message\_t *msg, error\_t error)} é a manipulação da interrupção de quando o acesso ao meio sem fio é garantido e assim coletar o tempo de acesso ao meio pelo cálculo do tempo que se passou entre o início do envio até ele ser concluído (\texttt{send/sendDone}). Ao final é enviado a mensagem de correção.

% \texttt{sendDone(message\_t *msg, error\_t error)} handles the interrupt when wireless medium access is granted to collect the medium access timestamp by compute the time that has passed between \texttt{send/sendDone} and send out the correction message. 

As linhas 21-22 mostram como o tempo de correção é calculado. O \texttt{seqNum} é utilizado para identificar qual mensagem será ajustada, \texttt{finalTime} e \texttt{initialTime} referem-se ao tempos $t_2$ e $t_1$ da Equação (\ref{eq:correction_time}).
% Lines 21-22 show how the correction time is computed. \texttt{seqNum} is used to identify which message is being adjusted, \texttt{finalTime} and \texttt{initialTime} refers to times $t2$ and $t1$ in Equation (\ref{eq:correction_time}).



